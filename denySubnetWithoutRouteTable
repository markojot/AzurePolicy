{
  "name": "AppendDefaultRouteTableIfMissing",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "displayName": "Append Default Route Table to Subnets if None is Attached",
    "policyType": "Custom",
    "mode": "All",
    "description": "This policy automatically appends the default route table to subnets if no route table is attached. It extracts the designation and environment from the subnet name (assumed to be in the format snet-<function>-<designation>-<environment>-<region>) and then builds the default route table resource ID. If any route table is already attached, the policy does nothing.",
    "metadata": {
      "version": "1.0.0",
      "category": "Network"
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Append",
        "allowedValues": [
          "Append",
          "Deny",
          "Audit",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "The effect to enforce (Append, Deny, Audit, or Disabled)."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Network/virtualNetworks/subnets"
          },
          {
            "exists": "false",
            "field": "Microsoft.Network/virtualNetworks/subnets/routeTable.id"
          }
        ]
      },
      "then": {
        "effect": "[parameters('effect')]",
        "details": [
          {
            "field": "Microsoft.Network/virtualNetworks/subnets/routeTable.id",
            "value": "[concat(subscription().id, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/routeTables/rt-default-', split(field('name'),'-')[2], '-', split(field('name'),'-')[3], '-', resourceGroup().location)]"
          }
        ]
      }
    }
  }
}